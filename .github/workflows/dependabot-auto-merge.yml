name: Auto-merge Dependabot PRs

on:
  pull_request:
    types:
      - opened
      - synchronize
  schedule:
    - cron: '*/1 * * * *'  # This cron expression runs every minute

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Check for existing open PRs
        id: check_open_prs
        run: |
          pr_count=$(curl -s "https://api.github.com/repos/${{ github.repository }}/pulls?state=open&base=dev" | jq '. | length')
          echo "Open PR count targeting dev branch: $pr_count"
          echo "pr_count=$pr_count" >> $GITHUB_ENV  # Use environment files instead of set-output

      - name: Exit if no open PRs
        if: env.pr_count == '0'
        run: |
          echo "No open PRs targeting dev branch. Exiting workflow."
          exit 0

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get pull request details
        id: get_pr_details
        run: |
          pr_url="https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}"
          pr_response=$(curl -s "$pr_url")
          echo "Pull Request details: $pr_response"
          compatibility_score=$(echo "$pr_response" | jq -r '.head.repo.compatibility_score')
          echo "Compatibility score is $compatibility_score"
          echo "compatibility_score=$compatibility_score" >> $GITHUB_ENV  # Use environment files

      - name: Check compatibility score and auto-merge
        run: |
          if [[ "${{ env.compatibility_score }}" == "100" ]]; then
            echo "Compatibility score is 100%, auto-merging..."
            gh pr merge ${{ github.event.pull_request.number }} --auto --squash --delete-branch
          else
            echo "Compatibility score is not 100%, skipping auto-merge."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
